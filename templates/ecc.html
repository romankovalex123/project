{% extends "base.html" %}

{% block title %}ECC - –≠–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∏–µ –ö—Ä–∏–≤—ã–µ{% endblock %}

{% block content %}
<div class="container">
    <h1>üîê –≠–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∏–µ –ö—Ä–∏–≤—ã–µ (ECC)</h1>

    <div class="theory-section">
        <h2>üìñ –¢–µ–æ—Ä–∏—è –≠–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∏—Ö –ö—Ä–∏–≤—ã—Ö</h2>
        <div class="theory-content">
            <div class="math-formula">
                y¬≤ = x¬≥ + ax + b
            </div>

            <h3>–ß—Ç–æ —Ç–∞–∫–æ–µ —ç–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∞—è –∫—Ä–∏–≤–∞—è?</h3>
            <p>–≠–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∞—è –∫—Ä–∏–≤–∞—è ‚Äî —ç—Ç–æ –≥–ª–∞–¥–∫–∞—è –∫—Ä–∏–≤–∞—è, –∑–∞–¥–∞–Ω–Ω–∞—è –∫—É–±–∏—á–µ—Å–∫–∏–º —É—Ä–∞–≤–Ω–µ–Ω–∏–µ–º. –í –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫—Ä–∏–≤—ã–µ –Ω–∞–¥ –∫–æ–Ω–µ—á–Ω—ã–º–∏ –ø–æ–ª—è–º–∏.</p>

            <h3>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:</h3>
            <div class="math-operations">
                <div class="operation">
                    <h4>–°–ª–æ–∂–µ–Ω–∏–µ —Ç–æ—á–µ–∫</h4>
                    <p>–î–ª—è —Ç–æ—á–µ–∫ P –∏ Q –Ω–∞ –∫—Ä–∏–≤–æ–π, –∏—Ö —Å—É–º–º–∞ R –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–∞–∫ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –æ—Å–∏ X —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –ø—Ä—è–º–æ–π PQ —Å –∫—Ä–∏–≤–æ–π.</p>
                </div>
                <div class="operation">
                    <h4>–£–¥–≤–æ–µ–Ω–∏–µ —Ç–æ—á–∫–∏</h4>
                    <p>–£–¥–≤–æ–µ–Ω–∏–µ —Ç–æ—á–∫–∏ P (P + P) –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é –∫–∞—Å–∞—Ç–µ–ª—å–Ω–æ–π –≤ —Ç–æ—á–∫–µ P.</p>
                </div>
                <div class="operation">
                    <h4>–°–∫–∞–ª—è—Ä–Ω–æ–µ —É–º–Ω–æ–∂–µ–Ω–∏–µ</h4>
                    <p>k √ó P = P + P + ... + P (k —Ä–∞–∑). –≠—Ç–æ –æ—Å–Ω–æ–≤–∞ ECC –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏.</p>
                </div>
            </div>

            <h3>–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è –Ω–∞ —ç–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∏—Ö –∫—Ä–∏–≤—ã—Ö:</h3>
            <ul>
                <li><strong>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:</strong> –û—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞—á–∏ –¥–∏—Å–∫—Ä–µ—Ç–Ω–æ–≥–æ –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –≥—Ä—É–ø–ø–µ —Ç–æ—á–µ–∫ —ç–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–æ–π –∫—Ä–∏–≤–æ–π</li>
                <li><strong>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> –¢—Ä–µ–±—É–µ—Ç –º–µ–Ω—å—à–∏—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –∫–ª—é—á–µ–π –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å RSA</li>
                <li><strong>–°–∫–æ—Ä–æ—Å—Ç—å:</strong> –ë—ã—Å—Ç—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏ —Ç–æ–π –∂–µ —É—Ä–æ–≤–Ω–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</li>
            </ul>

            <h3>–ù–∞—à–∞ –∫—Ä–∏–≤–∞—è:</h3>
            <p>–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—É—é –∫—Ä–∏–≤—É—é –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏: <strong>y¬≤ = x¬≥ + 7 mod 17</strong></p>
            <p>–≠—Ç–∞ –∫—Ä–∏–≤–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç <strong id="points-count">19</strong> —Ç–æ—á–µ–∫ (–≤–∫–ª—é—á–∞—è —Ç–æ—á–∫—É –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏)</p>
        </div>
    </div>

    <div class="demo-section">
        <h2>üéØ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≠–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–æ–π –ö—Ä–∏–≤–æ–π</h2>

        <div class="visualization-container">
            <div class="canvas-wrapper">
                <canvas id="curveCanvas" width="500" height="500"></canvas>
            </div>
            <div class="visualization-controls">
                <h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π:</h4>
                <div class="control-group">
                    <label>–ú–∞—Å—à—Ç–∞–±:</label>
                    <input type="range" id="scaleSlider" min="15" max="40" value="25" onchange="updateVisualization()">
                </div>
                <div class="legend">
                    <h4>–û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è:</h4>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #2c3e50"></span>
                        <span>–¢–æ—á–∫–∏ –∫—Ä–∏–≤–æ–π</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #e74c3c"></span>
                        <span>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä G</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #3498db"></span>
                        <span>–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á Q</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #2ecc71"></span>
                        <span>–¢–æ—á–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è M</span>
                    </div>
                </div>

                <div class="point-operations">
                    <h4>–†–∞–±–æ—Ç–∞ —Å —Ç–æ—á–∫–∞–º–∏:</h4>

                    <div class="control-group">
                        <label>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É (x, y):</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="number" id="custom-point-x" placeholder="x" min="0" max="16" style="width: 60px;">
                            <input type="number" id="custom-point-y" placeholder="y" min="0" max="16" style="width: 60px;">
                        </div>
                        <button onclick="addCustomPoint()" class="btn btn-small" style="margin-top: 0.5rem;">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</button>
                        <button onclick="clearCustomPoints()" class="btn btn-small btn-outline">–û—á–∏—Å—Ç–∏—Ç—å —Ç–æ—á–∫–∏</button>
                    </div>

                    <div class="control-group">
                        <label>–í–∞—à–∏ —Ç–æ—á–∫–∏:</label>
                        <ul id="custom-points-list" style="font-size: 0.8rem; max-height: 100px; overflow-y: auto; background: white; padding: 0.5rem; border-radius: 4px;"></ul>
                    </div>

                    <div class="control-group">
                        <label>–û–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ç–æ—á–∫–∞–º–∏:</label>
                        <button onclick="addPoints()" class="btn btn-small" style="margin: 0.25rem; width: 100%;">–°–ª–æ–∂–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Ç–æ—á–∫–∏</button>
                        <button onclick="doublePoint()" class="btn btn-small" style="margin: 0.25rem; width: 100%;">–£–¥–≤–æ–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫—É</button>
                        <div style="display: flex; gap: 0.5rem; margin: 0.25rem 0;">
                            <input type="number" id="multiplier-k" placeholder="k" min="1" max="10" style="width: 60px;">
                            <button onclick="multiplyPoint()" class="btn btn-small" style="flex: 1;">–£–º–Ω–æ–∂–∏—Ç—å –Ω–∞ k</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏:</label>
                        <div id="operation-result" style="background: white; padding: 0.5rem; border-radius: 4px; font-family: monospace; font-size: 0.9rem;">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="crypto-operations">
            <div class="operation-panel">
                <h3>üîë –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π</h3>
                <button onclick="generateECCKeys()" class="btn btn-primary">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏</button>
                <div class="key-display">
                    <div class="key-item">
                        <label>–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (d):</label>
                        <code id="ecc-private-key">-</code>
                    </div>
                    <div class="key-item">
                        <label>–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á (Q = d√óG):</label>
                        <code id="ecc-public-key">-</code>
                    </div>
                </div>
            </div>

            <div class="operation-panel">
                <h3>üîí –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ</h3>
                <div class="input-group">
                    <label>–°–æ–æ–±—â–µ–Ω–∏–µ (x-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ 1-16):</label>
                    <input type="number" id="ecc-message" value="5" min="1" max="16">
                    <button onclick="encryptECC()" class="btn btn-primary">–ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div class="result-display">
                    <div class="result-item">
                        <label>–¢–æ—á–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è M:</label>
                        <code id="ecc-message-point">-</code>
                    </div>
                    <div class="result-item">
                        <label>–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ C1 = k√óG:</label>
                        <code id="ecc-ciphertext1">-</code>
                    </div>
                    <div class="result-item">
                        <label>–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ C2 = M + k√óQ:</label>
                        <code id="ecc-ciphertext2">-</code>
                    </div>
                </div>
            </div>

            <div class="operation-panel">
                <h3>üîì –î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ</h3>
                <button onclick="decryptECC()" class="btn btn-success">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
                <div class="result-item">
                    <label>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</label>
                    <code id="ecc-decrypted">-</code>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
class EllipticCurveVisualizer {
    constructor(canvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        this.points = [];
        this.specialPoints = {};
        this.scale = 25;
        this.offsetX = this.canvas.width / 2;
        this.offsetY = this.canvas.height / 2;
        this.connections = [];
        this.customPoints = [];
    }

    drawGrid() {
        const ctx = this.ctx;
        const width = this.canvas.width;
        const height = this.canvas.height;

        // –§–æ–Ω
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, width, height);

        // –°–µ—Ç–∫–∞
        ctx.strokeStyle = '#e9ecef';
        ctx.lineWidth = 1;

        // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
        for (let x = this.offsetX % this.scale; x < width; x += this.scale) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
            ctx.stroke();
        }

        // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
        for (let y = this.offsetY % this.scale; y < height; y += this.scale) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(width, y);
            ctx.stroke();
        }

        // –û—Å–∏
        ctx.strokeStyle = '#adb5bd';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(this.offsetX, 0);
        ctx.lineTo(this.offsetX, height);
        ctx.moveTo(0, this.offsetY);
        ctx.lineTo(width, this.offsetY);
        ctx.stroke();

        // –ü–æ–¥–ø–∏—Å–∏ –æ—Å–µ–π
        ctx.fillStyle = '#6c757d';
        ctx.font = '12px Arial';
        ctx.fillText('x', width - 10, this.offsetY - 5);
        ctx.fillText('y', this.offsetX + 5, 10);
    }

    drawPoint(x, y, color = '#2c3e50', label = '', radius = 4, isCustom = false) {
        const ctx = this.ctx;
        const canvasX = this.offsetX + x * this.scale;
        const canvasY = this.offsetY - y * this.scale;

        // –¢–µ–Ω—å
        ctx.shadowColor = 'rgba(0,0,0,0.2)';
        ctx.shadowBlur = 3;
        ctx.shadowOffsetX = 1;
        ctx.shadowOffsetY = 1;

        // –¢–æ—á–∫–∞
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(canvasX, canvasY, radius, 0, 2 * Math.PI);
        ctx.fill();

        // –û–±–≤–æ–¥–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç–æ—á–µ–∫
        if (isCustom) {
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–Ω—å –¥–ª—è —Ç–µ–∫—Å—Ç–∞
        ctx.shadowColor = 'transparent';
        ctx.shadowBlur = 0;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;

        if (label) {
            ctx.fillStyle = color;
            ctx.font = 'bold 13px Arial';
            ctx.fillText(label, canvasX + 8, canvasY - 8);
        }
    }

    drawConnection(point1, point2, color = '#95a5a6') {
        const ctx = this.ctx;
        const x1 = this.offsetX + point1[0] * this.scale;
        const y1 = this.offsetY - point1[1] * this.scale;
        const x2 = this.offsetX + point2[0] * this.scale;
        const y2 = this.offsetY - point2[1] * this.scale;

        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 3]);
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    drawCurve() {
        this.drawGrid();

        // –†–∏—Å—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
        this.connections.forEach(conn => {
            this.drawConnection(conn.from, conn.to, conn.color);
        });

        // –†–∏—Å—É–µ–º –≤—Å–µ —Ç–æ—á–∫–∏ –∫—Ä–∏–≤–æ–π
        this.points.forEach(point => {
            this.drawPoint(point[0], point[1], '#2c3e50', '', 3);
        });

        // –†–∏—Å—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ç–æ—á–∫–∏
        this.customPoints.forEach((point, index) => {
            this.drawPoint(point[0], point[1], '#e74c3c', `P${index}`, 6, true);
        });

        // –†–∏—Å—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏
        if (this.specialPoints.generator) {
            const g = this.specialPoints.generator;
            this.drawPoint(g[0], g[1], '#e74c3c', 'G', 6);
        }

        if (this.specialPoints.publicKey) {
            const pub = this.specialPoints.publicKey;
            this.drawPoint(pub[0], pub[1], '#3498db', 'Q', 6);
        }

        if (this.specialPoints.messagePoint) {
            const msg = this.specialPoints.messagePoint;
            this.drawPoint(msg[0], msg[1], '#2ecc71', 'M', 6);
        }

        if (this.specialPoints.C1) {
            const c1 = this.specialPoints.C1;
            this.drawPoint(c1[0], c1[1], '#f39c12', 'C1', 6);
        }

        if (this.specialPoints.C2) {
            const c2 = this.specialPoints.C2;
            this.drawPoint(c2[0], c2[1], '#9b59b6', 'C2', 6);
        }

        // –†–∏—Å—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø–µ—Ä–∞—Ü–∏–π
        if (this.specialPoints.operationResult) {
            const result = this.specialPoints.operationResult;
            this.drawPoint(result[0], result[1], '#d35400', 'R', 6);
        }
    }

    addConnection(from, to, color = '#95a5a6') {
        this.connections.push({ from, to, color });
    }

    clearConnections() {
        this.connections = [];
    }

    addCustomPoint(x, y) {
        this.customPoints.push([x, y]);
        this.drawCurve();
    }

    clearCustomPoints() {
        this.customPoints = [];
        this.drawCurve();
    }

    setPoints(points) {
        this.points = points;
    }

    setSpecialPoints(points) {
        this.specialPoints = points;
    }

    setScale(scale) {
        this.scale = scale;
        this.drawCurve();
    }

    clear() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.points = [];
        this.specialPoints = {};
        this.connections = [];
        this.customPoints = [];
    }
}

// –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
const visualizer = new EllipticCurveVisualizer('curveCanvas');

function updateVisualization() {
    const scale = document.getElementById('scaleSlider').value;
    visualizer.setScale(parseInt(scale));
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–æ—á–∫–∞–º–∏
function addCustomPoint() {
    const x = parseInt(document.getElementById('custom-point-x').value);
    const y = parseInt(document.getElementById('custom-point-y').value);

    if (isNaN(x) || isNaN(y)) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ—á–∫–∞ –Ω–∞ –∫—Ä–∏–≤–æ–π
    const isValid = visualizer.points.some(point => point[0] === x && point[1] === y);
    if (!isValid) {
        alert(`–¢–æ—á–∫–∞ (${x}, ${y}) –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –∫—Ä–∏–≤–æ–π y¬≤ = x¬≥ + 7 mod 17`);
        return;
    }

    visualizer.addCustomPoint(x, y);
    updateCustomPointsList();
}

function updateCustomPointsList() {
    const list = document.getElementById('custom-points-list');
    list.innerHTML = '';

    visualizer.customPoints.forEach((point, index) => {
        const li = document.createElement('li');
        li.textContent = `P${index} = (${point[0]}, ${point[1]})`;
        list.appendChild(li);
    });
}

function clearCustomPoints() {
    visualizer.clearCustomPoints();
    document.getElementById('custom-points-list').innerHTML = '';
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ç–æ—á–∫–∞–º–∏
async function addPoints() {
    if (visualizer.customPoints.length < 2) {
        alert('–î–æ–±–∞–≤—å—Ç–µ –∫–∞–∫ –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏ –¥–ª—è —Å–ª–æ–∂–µ–Ω–∏—è');
        return;
    }

    const point1 = visualizer.customPoints[visualizer.customPoints.length - 2];
    const point2 = visualizer.customPoints[visualizer.customPoints.length - 1];

    const response = await fetch('/api/ecc/add_points', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            point1: point1,
            point2: point2
        })
    });

    const data = await response.json();

    if (data.result) {
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        visualizer.addConnection(point1, data.result, '#27ae60');
        visualizer.addConnection(point2, data.result, '#27ae60');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        visualizer.setSpecialPoints({
            ...visualizer.specialPoints,
            operationResult: data.result
        });

        visualizer.drawCurve();

        document.getElementById('operation-result').textContent =
            `(${point1[0]},${point1[1]}) + (${point2[0]},${point2[1]}) = (${data.result[0]},${data.result[1]})`;
    } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ª–æ–∂–µ–Ω–∏–∏ —Ç–æ—á–µ–∫');
    }
}

async function doublePoint() {
    if (visualizer.customPoints.length < 1) {
        alert('–î–æ–±–∞–≤—å—Ç–µ —Ç–æ—á–∫—É –¥–ª—è —É–¥–≤–æ–µ–Ω–∏—è');
        return;
    }

    const point = visualizer.customPoints[visualizer.customPoints.length - 1];

    const response = await fetch('/api/ecc/double_point', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            point: point
        })
    });

    const data = await response.json();

    if (data.result) {
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        visualizer.addConnection(point, data.result, '#f39c12');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        visualizer.setSpecialPoints({
            ...visualizer.specialPoints,
            operationResult: data.result
        });

        visualizer.drawCurve();

        document.getElementById('operation-result').textContent =
            `2 √ó (${point[0]},${point[1]}) = (${data.result[0]},${data.result[1]})`;
    } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–≤–æ–µ–Ω–∏–∏ —Ç–æ—á–∫–∏');
    }
}

async function multiplyPoint() {
    if (visualizer.customPoints.length < 1) {
        alert('–î–æ–±–∞–≤—å—Ç–µ —Ç–æ—á–∫—É –¥–ª—è —É–º–Ω–æ–∂–µ–Ω–∏—è');
        return;
    }

    const k = parseInt(document.getElementById('multiplier-k').value);
    const point = visualizer.customPoints[visualizer.customPoints.length - 1];

    if (isNaN(k) || k < 1) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å k');
        return;
    }

    const response = await fetch('/api/ecc/multiply_point', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            k: k,
            point: point
        })
    });

    const data = await response.json();

    if (data.result) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        visualizer.setSpecialPoints({
            ...visualizer.specialPoints,
            operationResult: data.result
        });

        visualizer.drawCurve();

        document.getElementById('operation-result').textContent =
            `${k} √ó (${point[0]},${point[1]}) = (${data.result[0]},${data.result[1]})`;
    } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–º–Ω–æ–∂–µ–Ω–∏–∏ —Ç–æ—á–∫–∏');
    }
}

// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
async function generateECCKeys() {
    const response = await fetch('/api/ecc/generate_keys', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    });
    const data = await response.json();

    document.getElementById('ecc-private-key').textContent = data.private_key;
    document.getElementById('ecc-public-key').textContent = `(${data.public_key[0]}, ${data.public_key[1]})`;

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
    visualizer.setPoints(data.curve_points);
    visualizer.setSpecialPoints({
        generator: data.generator,
        publicKey: data.public_key
    });
    visualizer.drawCurve();

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ç–æ—á–µ–∫
    document.getElementById('points-count').textContent = data.curve_points.length;
}

async function encryptECC() {
    const publicKey = document.getElementById('ecc-public-key').textContent;
    const message = document.getElementById('ecc-message').value;

    if (publicKey === '-') {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–ª—é—á–∏!');
        return;
    }

    const match = publicKey.match(/\((\d+), (\d+)\)/);
    const pubKey = [parseInt(match[1]), parseInt(match[2])];

    const response = await fetch('/api/ecc/encrypt', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            public_key: pubKey,
            message: parseInt(message)
        })
    });
    const data = await response.json();

    document.getElementById('ecc-ciphertext1').textContent = `(${data.C1[0]}, ${data.C1[1]})`;
    document.getElementById('ecc-ciphertext2').textContent = `(${data.C2[0]}, ${data.C2[1]})`;
    document.getElementById('ecc-message-point').textContent = `(${data.message_point[0]}, ${data.message_point[1]})`;

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —Å —Ç–æ—á–∫–∞–º–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
    visualizer.setSpecialPoints({
        ...visualizer.specialPoints,
        messagePoint: data.message_point,
        C1: data.C1,
        C2: data.C2
    });
    visualizer.drawCurve();
}

async function decryptECC() {
    const privateKey = document.getElementById('ecc-private-key').textContent;
    const cipher1 = document.getElementById('ecc-ciphertext1').textContent;
    const cipher2 = document.getElementById('ecc-ciphertext2').textContent;

    if (privateKey === '-' || cipher1 === '-') {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–ª—é—á–∏ –∏ –∑–∞—à–∏—Ñ—Ä—É–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!');
        return;
    }

    const match1 = cipher1.match(/\((\d+), (\d+)\)/);
    const match2 = cipher2.match(/\((\d+), (\d+)\)/);

    const C1 = [parseInt(match1[1]), parseInt(match1[2])];
    const C2 = [parseInt(match2[1]), parseInt(match2[2])];

    const response = await fetch('/api/ecc/decrypt', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            private_key: parseInt(privateKey),
            C1: C1,
            C2: C2
        })
    });
    const data = await response.json();

    document.getElementById('ecc-decrypted').textContent = data.decrypted;
}

function clearECC() {
    document.getElementById('ecc-private-key').textContent = '-';
    document.getElementById('ecc-public-key').textContent = '-';
    document.getElementById('ecc-ciphertext1').textContent = '-';
    document.getElementById('ecc-ciphertext2').textContent = '-';
    document.getElementById('ecc-decrypted').textContent = '-';
    document.getElementById('ecc-message-point').textContent = '-';
    document.getElementById('operation-result').textContent = '-';

    visualizer.clear();
    updateCustomPointsList();
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—Ä–∏–≤—É—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('load', function() {
    fetch('/api/ecc/get_curve', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    }).then(response => response.json())
      .then(data => {
          visualizer.setPoints(data.curve_points);
          visualizer.setSpecialPoints({
              generator: data.generator
          });
          visualizer.drawCurve();
          document.getElementById('points-count').textContent = data.curve_points.length;
      });
});
</script>
{% endblock %}